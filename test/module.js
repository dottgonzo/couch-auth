"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var chai = require("chai");
var index_1 = require("../index");
var spawnPouchdbServer = require('spawn-pouchdb-server');
var axios = require("axios");
var testport = 8742;
var adminUser = {
    user: 'adminuser',
    password: 'adminpass'
};
var user0 = {
    user: 'testuser0',
    password: 'testpassw0'
};
var slaveuser = {
    user: 'slaveslave1',
    password: 'slavepassw1'
};
var expect = chai.expect;
var Server;
var aa = 'ss';
var CouchAuth;
before(function (done) {
    this.timeout(20000);
    spawnPouchdbServer({
        port: testport,
        backend: false,
        config: {
            admins: { "adminuser": "adminpass" },
            file: false
        },
        log: {
            file: false,
            level: 'none'
        },
        verbose: false
    }, function (error, server) {
        if (error) {
            throw error;
        }
        else {
            Server = server;
            CouchAuth = new index_1.couchAccess({
                hostname: 'localhost',
                protocol: 'http',
                port: testport,
                user: adminUser.user,
                password: adminUser.password
            });
            setTimeout(function () {
                done();
            }, 2000);
        }
    });
});
describe("modules", function () {
    describe("test app_main", function () {
        this.timeout(20000);
        it("verificate presence of app_main db", function (done) {
            axios.get(CouchAuth.my('app_main')).then(function (d) {
                axios.put(CouchAuth.my('app_main') + '/testdoctobepresent0', { _id: 'testdoctobepresent0', ee: true }).then(function (d) {
                    expect(d).to.be.ok;
                    expect(d).to.be.an('object');
                    done();
                }).catch(function (err) {
                    console.error(err);
                    done(Error(err));
                });
            }).catch(function (err) {
                done(Error(err));
            });
        });
        it("verificate presence of service doc", function (done) {
            axios.get(CouchAuth.my('app_main') + '/services').then(function (d) {
                expect(d).to.be.ok;
                expect(d).to.be.an('object');
                done();
            }).catch(function (err) {
                done(Error(err));
            });
        });
        it("verificate that app_main db is not public", function (done) {
            axios.get(CouchAuth.publink + '/app_main/testdocnotbepresent0').then(function (d) {
                done(Error(JSON.stringify(d)));
            }).catch(function (err) {
                expect(err).to.be.ok;
                done();
            });
        });
        it("verificate admin user", function (done) {
            axios.get(CouchAuth.my('_users/org.couchdb.user:' + adminUser.user)).then(function (resp) {
                var d = resp.data;
                expect(d).to.be.ok;
                expect(d).to.have.property('name').that.eq(adminUser.user);
                expect(d).to.have.property('roles').that.is.an('array');
                expect(d).to.have.property('db').that.is.an('array');
                done();
            }).catch(function (err) {
                done(Error(err));
            });
        });
    });
    describe("user managment", function () {
        this.timeout(20000);
        it("an admin can add a common user with no db that can login by themselves", function (done) {
            CouchAuth.createUser(adminUser, user0).then(function () {
                CouchAuth.login(user0).then(function (d) {
                    expect(d).to.be.ok;
                    done();
                }).catch(function (err) {
                    console.error(err);
                    done(Error(err));
                });
            }).catch(function (err) {
                console.error(err);
                done(Error(err));
            });
        });
        it("verificate that app_main db is not readable to other users", function (done) {
            axios.get(CouchAuth.for(user0.user, user0.password) + '/app_main/testdocnotbepresent0').then(function (d) {
                done(Error(JSON.stringify(d)));
            }).catch(function (err) {
                expect(err).to.be.ok;
                done();
            });
        });
    });
    describe("create a new service app", function () {
        it("main admin add first app for a slave user", function (done) {
            this.timeout(20000);
            CouchAuth.createServiceApp(adminUser, 'testapp', slaveuser).then(function () {
                axios.get(CouchAuth.my('service_testapp') + '/_security').then(function (d) {
                    expect(d).to.be.ok;
                    expect(d).to.be.an('object');
                    done();
                }).catch(function (err) {
                    console.error(err);
                    done(Error(err));
                });
            }).catch(function (err) {
                done(Error(err));
            });
        });
        it("check the service list", function (done) {
            this.timeout(20000);
            CouchAuth.getServices(adminUser).then(function (d) {
                expect(d).to.be.ok;
                expect(d).to.be.an('Array');
                expect(d.length).to.be.eq(1);
                done();
            }).catch(function (err) {
                done(Error(err));
            });
        });
        it("check that slave user can put a document", function (done) {
            this.timeout(20000);
            axios.put(CouchAuth.for(slaveuser.user, slaveuser.password) + '/service_testapp/testnewdoc0', { _id: 'testnewdoc0', ee: true }).then(function (d) {
                expect(d).to.be.ok;
                expect(d).to.be.an('object');
                done();
            }).catch(function (err) {
                console.error(err);
                done(Error(err));
            });
        });
        it("unregistered users can't access", function (done) {
            this.timeout(20000);
            axios.get(CouchAuth.publink + '/service_testapp/testdoctobepresent0').then(function (d) {
                done(Error(JSON.stringify(d)));
            }).catch(function (err) {
                expect(err).to.be.ok;
                done();
            });
        });
        it("other users can't access", function (done) {
            this.timeout(20000);
            axios.get(CouchAuth.for(user0.user, user0.password) + '/service_testapp/testdoctobepresent0').then(function (d) {
                done(new Error(JSON.stringify(d)));
            }).catch(function (err) {
                expect(err).to.be.ok;
                done();
            });
        });
    });
    describe("create a new public app (an app read only)", function () {
        it("main admin add ro app", function (done) {
            this.timeout(20000);
            CouchAuth.createPubApp(adminUser, 'testapp2').then(function (d) {
                axios.put(CouchAuth.my('pub_testapp2') + '/testdoctobepresent0', { _id: 'testdoctobepresent0', ee: true }).then(function (d) {
                    expect(d).to.be.ok;
                    expect(d).to.be.an('object');
                    done();
                }).catch(function (err) {
                    console.error(err);
                    done(new Error(err));
                });
            }).catch(function (err) {
                done(new Error(err));
            });
        });
        it("unregistered users can read from a public app", function (done) {
            this.timeout(20000);
            axios.get(CouchAuth.publink + '/pub_testapp2/testdoctobepresent0').then(function (d) {
                expect(d).to.be.ok;
                done();
            }).catch(function (err) {
                console.error(err);
                done(new Error(err));
            });
        });
        it("registered users can read from a public app", function (done) {
            this.timeout(20000);
            axios.get(CouchAuth.for(user0.user, user0.password) + '/pub_testapp2/testdoctobepresent0').then(function (d) {
                expect(d).to.be.ok;
                done();
            }).catch(function (err) {
                console.error(err);
                done(new Error(err));
            });
        });
        it("unregistered users can't add docs to a public app", function (done) {
            this.timeout(20000);
            axios.put(CouchAuth.publink + '/pub_testapp2/cccn', { _id: 'cccn', aa: true }).then(function (d) {
                console.error(d);
                done(new Error(JSON.stringify(d)));
            }).catch(function (err) {
                expect(err).to.be.ok;
                done();
            });
        });
        it("registered users can't add docs", function (done) {
            this.timeout(20000);
            axios.put(CouchAuth.for(user0.user, user0.password) + '/pub_testapp2/cccb', { _id: 'cccb', aa: true }).then(function (d) {
                done(new Error(JSON.stringify(d)));
            }).catch(function (err) {
                expect(err).to.be.ok;
                done();
            });
        });
    });
});
after(function (done) {
    Server.stop(function () {
        done();
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQTtnQkFDcEIsSUFBSSxFQUFFLENBQUE7WUFDVixDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO0lBR04sQ0FBQyxDQUFDLENBQUE7QUFLTixDQUFDLENBQUMsQ0FBQTtBQUVGLEtBQUssQ0FBQyxVQUFVLElBQUk7SUFDaEIsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNSLElBQUksRUFBRSxDQUFBO0lBQ1YsQ0FBQyxDQUFDLENBQUE7QUFFTixDQUFDLENBQUMsQ0FBQSIsImZpbGUiOiJ0ZXN0L21vZHVsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIG1vY2hhIGZyb20gXCJtb2NoYVwiXG5pbXBvcnQgKiBhcyBjaGFpIGZyb20gXCJjaGFpXCJcblxuaW1wb3J0IHsgY291Y2hBY2Nlc3MgfSBmcm9tIFwiLi4vaW5kZXhcIlxuXG5jb25zdCBzcGF3blBvdWNoZGJTZXJ2ZXIgPSByZXF1aXJlKCdzcGF3bi1wb3VjaGRiLXNlcnZlcicpXG5cbmltcG9ydCAqIGFzIGF4aW9zIGZyb20gJ2F4aW9zJ1xuXG5jb25zdCB0ZXN0cG9ydCA9IDg3NDJcblxuXG5cbmNvbnN0IGFkbWluVXNlciA9IHtcbiAgICB1c2VyOiAnYWRtaW51c2VyJyxcbiAgICBwYXNzd29yZDogJ2FkbWlucGFzcydcbn1cblxuY29uc3QgdXNlcjAgPSB7XG4gICAgdXNlcjogJ3Rlc3R1c2VyMCcsXG4gICAgcGFzc3dvcmQ6ICd0ZXN0cGFzc3cwJ1xufVxuXG5jb25zdCBzbGF2ZXVzZXIgPSB7XG4gICAgdXNlcjogJ3NsYXZlc2xhdmUxJyxcbiAgICBwYXNzd29yZDogJ3NsYXZlcGFzc3cxJ1xufVxuXG5sZXQgZXhwZWN0ID0gY2hhaS5leHBlY3RcblxuXG5sZXQgU2VydmVyXG5sZXQgYWEgPSAnc3MnXG5cblxubGV0IENvdWNoQXV0aDogY291Y2hBY2Nlc3NcblxuXG5cbmJlZm9yZShmdW5jdGlvbiAoZG9uZSkge1xuICAgIHRoaXMudGltZW91dCgyMDAwMClcbiAgICBzcGF3blBvdWNoZGJTZXJ2ZXIoXG4gICAgICAgIHtcbiAgICAgICAgICAgIHBvcnQ6IHRlc3Rwb3J0LFxuICAgICAgICAgICAgYmFja2VuZDogZmFsc2UsXG4gICAgICAgICAgICBjb25maWc6IHtcbiAgICAgICAgICAgICAgICBhZG1pbnM6IHsgXCJhZG1pbnVzZXJcIjogXCJhZG1pbnBhc3NcIiB9LFxuICAgICAgICAgICAgICAgIGZpbGU6IGZhbHNlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbG9nOiB7XG4gICAgICAgICAgICAgICAgZmlsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgbGV2ZWw6ICdub25lJ1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHZlcmJvc2U6IGZhbHNlXG4gICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvciwgc2VydmVyKSB7XG4gICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvclxuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIFNlcnZlciA9IHNlcnZlclxuXG5cbiAgICAgICAgICAgICAgICBDb3VjaEF1dGggPSBuZXcgY291Y2hBY2Nlc3Moe1xuICAgICAgICAgICAgICAgICAgICBob3N0bmFtZTogJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgICAgICAgICAgIHByb3RvY29sOiAnaHR0cCcsXG4gICAgICAgICAgICAgICAgICAgIHBvcnQ6IHRlc3Rwb3J0LFxuICAgICAgICAgICAgICAgICAgICB1c2VyOiBhZG1pblVzZXIudXNlcixcbiAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQ6IGFkbWluVXNlci5wYXNzd29yZFxuICAgICAgICAgICAgICAgIH0pXG5cblxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBkb25lKClcbiAgICAgICAgICAgICAgICB9LCAyMDAwKVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuXG5cblxuXG5cblxuXG59KVxuZGVzY3JpYmUoXCJtb2R1bGVzXCIsIGZ1bmN0aW9uICgpIHtcblxuXG4gICAgZGVzY3JpYmUoXCJ0ZXN0IGFwcF9tYWluXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy50aW1lb3V0KDIwMDAwKVxuXG4gICAgICAgIGl0KFwidmVyaWZpY2F0ZSBwcmVzZW5jZSBvZiBhcHBfbWFpbiBkYlwiLCBmdW5jdGlvbiAoZG9uZSkge1xuXG5cbiAgICAgICAgICAgIGF4aW9zLmdldChDb3VjaEF1dGgubXkoJ2FwcF9tYWluJykpLnRoZW4oZnVuY3Rpb24gKGQpIHtcblxuICAgICAgICAgICAgICAgIGF4aW9zLnB1dChDb3VjaEF1dGgubXkoJ2FwcF9tYWluJykgKyAnL3Rlc3Rkb2N0b2JlcHJlc2VudDAnLCB7IF9pZDogJ3Rlc3Rkb2N0b2JlcHJlc2VudDAnLCBlZTogdHJ1ZSB9KS50aGVuKGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICAgICAgICAgIGV4cGVjdChkKS50by5iZS5va1xuICAgICAgICAgICAgICAgICAgICBleHBlY3QoZCkudG8uYmUuYW4oJ29iamVjdCcpXG4gICAgICAgICAgICAgICAgICAgIGRvbmUoKVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpXG4gICAgICAgICAgICAgICAgICAgIGRvbmUoRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICAgICB9KVxuXG5cbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBkb25lKEVycm9yKGVycikpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgICAgICBpdChcInZlcmlmaWNhdGUgcHJlc2VuY2Ugb2Ygc2VydmljZSBkb2NcIiwgZnVuY3Rpb24gKGRvbmUpIHtcblxuXG4gICAgICAgICAgICBheGlvcy5nZXQoQ291Y2hBdXRoLm15KCdhcHBfbWFpbicpICsgJy9zZXJ2aWNlcycpLnRoZW4oZnVuY3Rpb24gKGQpIHtcblxuICAgICAgICAgICAgICAgIGV4cGVjdChkKS50by5iZS5va1xuICAgICAgICAgICAgICAgIGV4cGVjdChkKS50by5iZS5hbignb2JqZWN0JylcbiAgICAgICAgICAgICAgICBkb25lKClcblxuXG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgZG9uZShFcnJvcihlcnIpKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgICAgaXQoXCJ2ZXJpZmljYXRlIHRoYXQgYXBwX21haW4gZGIgaXMgbm90IHB1YmxpY1wiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgLy8gICAgY29uc29sZS5sb2coQ291Y2hBdXRoLm15KCdhcHBfbWFpbicpKVxuICAgICAgICAgICAgYXhpb3MuZ2V0KENvdWNoQXV0aC5wdWJsaW5rICsgJy9hcHBfbWFpbi90ZXN0ZG9jbm90YmVwcmVzZW50MCcpLnRoZW4oZnVuY3Rpb24gKGQpIHtcbiAgICAgICAgICAgICAgICBkb25lKEVycm9yKEpTT04uc3RyaW5naWZ5KGQpKSlcbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBleHBlY3QoZXJyKS50by5iZS5va1xuICAgICAgICAgICAgICAgIGRvbmUoKVxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9KVxuXG4gICAgICAgIGl0KFwidmVyaWZpY2F0ZSBhZG1pbiB1c2VyXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICAvLyAgICBjb25zb2xlLmxvZyhDb3VjaEF1dGgubXkoJ2FwcF9tYWluJykpXG4gICAgICAgICAgICBheGlvcy5nZXQoQ291Y2hBdXRoLm15KCdfdXNlcnMvb3JnLmNvdWNoZGIudXNlcjonICsgYWRtaW5Vc2VyLnVzZXIpKS50aGVuKGZ1bmN0aW9uIChyZXNwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZCA9IHJlc3AuZGF0YVxuICAgICAgICAgICAgICAgIGV4cGVjdChkKS50by5iZS5va1xuICAgICAgICAgICAgICAgIGV4cGVjdChkKS50by5oYXZlLnByb3BlcnR5KCduYW1lJykudGhhdC5lcShhZG1pblVzZXIudXNlcilcbiAgICAgICAgICAgICAgICBleHBlY3QoZCkudG8uaGF2ZS5wcm9wZXJ0eSgncm9sZXMnKS50aGF0LmlzLmFuKCdhcnJheScpXG4gICAgICAgICAgICAgICAgZXhwZWN0KGQpLnRvLmhhdmUucHJvcGVydHkoJ2RiJykudGhhdC5pcy5hbignYXJyYXknKVxuICAgICAgICAgICAgICAgIGRvbmUoKVxuICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGRvbmUoRXJyb3IoZXJyKSlcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfSlcblxuXG4gICAgfSlcblxuXG4gICAgZGVzY3JpYmUoXCJ1c2VyIG1hbmFnbWVudFwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRoaXMudGltZW91dCgyMDAwMClcbiAgICAgICAgaXQoXCJhbiBhZG1pbiBjYW4gYWRkIGEgY29tbW9uIHVzZXIgd2l0aCBubyBkYiB0aGF0IGNhbiBsb2dpbiBieSB0aGVtc2VsdmVzXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICBDb3VjaEF1dGguY3JlYXRlVXNlcihhZG1pblVzZXIsIHVzZXIwKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBDb3VjaEF1dGgubG9naW4odXNlcjApLnRoZW4oKGQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZXhwZWN0KGQpLnRvLmJlLm9rXG4gICAgICAgICAgICAgICAgICAgIGRvbmUoKVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpXG4gICAgICAgICAgICAgICAgICAgIGRvbmUoRXJyb3IoZXJyKSlcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKVxuICAgICAgICAgICAgICAgIGRvbmUoRXJyb3IoZXJyKSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG5cblxuICAgICAgICBpdChcInZlcmlmaWNhdGUgdGhhdCBhcHBfbWFpbiBkYiBpcyBub3QgcmVhZGFibGUgdG8gb3RoZXIgdXNlcnNcIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIGF4aW9zLmdldChDb3VjaEF1dGguZm9yKHVzZXIwLnVzZXIsIHVzZXIwLnBhc3N3b3JkKSArICcvYXBwX21haW4vdGVzdGRvY25vdGJlcHJlc2VudDAnKS50aGVuKGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICAgICAgZG9uZShFcnJvcihKU09OLnN0cmluZ2lmeShkKSkpXG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGVycikudG8uYmUub2tcbiAgICAgICAgICAgICAgICBkb25lKClcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfSlcblxuXG4gICAgfSlcblxuICAgIGRlc2NyaWJlKFwiY3JlYXRlIGEgbmV3IHNlcnZpY2UgYXBwXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaXQoXCJtYWluIGFkbWluIGFkZCBmaXJzdCBhcHAgZm9yIGEgc2xhdmUgdXNlclwiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgdGhpcy50aW1lb3V0KDIwMDAwKVxuXG4gICAgICAgICAgICBDb3VjaEF1dGguY3JlYXRlU2VydmljZUFwcChhZG1pblVzZXIsICd0ZXN0YXBwJywgc2xhdmV1c2VyKS50aGVuKGZ1bmN0aW9uICgpIHtcblxuICAgICAgICAgICAgICAgIGF4aW9zLmdldChDb3VjaEF1dGgubXkoJ3NlcnZpY2VfdGVzdGFwcCcpICsgJy9fc2VjdXJpdHknKS50aGVuKGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICAgICAgICAgIGV4cGVjdChkKS50by5iZS5va1xuICAgICAgICAgICAgICAgICAgICBleHBlY3QoZCkudG8uYmUuYW4oJ29iamVjdCcpXG4gICAgICAgICAgICAgICAgICAgIGRvbmUoKVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpXG4gICAgICAgICAgICAgICAgICAgIGRvbmUoRXJyb3IoZXJyKSlcblxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBkb25lKEVycm9yKGVycikpXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIH0pXG4gICAgICAgIGl0KFwiY2hlY2sgdGhlIHNlcnZpY2UgbGlzdFwiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgdGhpcy50aW1lb3V0KDIwMDAwKVxuXG4gICAgICAgICAgICBDb3VjaEF1dGguZ2V0U2VydmljZXMoYWRtaW5Vc2VyKS50aGVuKGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGQpLnRvLmJlLm9rXG4gICAgICAgICAgICAgICAgZXhwZWN0KGQpLnRvLmJlLmFuKCdBcnJheScpXG4gICAgICAgICAgICAgICAgZXhwZWN0KGQubGVuZ3RoKS50by5iZS5lcSgxKVxuXG4gICAgICAgICAgICAgICAgZG9uZSgpXG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgZG9uZShFcnJvcihlcnIpKVxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9KVxuICAgICAgICBpdChcImNoZWNrIHRoYXQgc2xhdmUgdXNlciBjYW4gcHV0IGEgZG9jdW1lbnRcIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIHRoaXMudGltZW91dCgyMDAwMClcblxuICAgICAgICAgICAgYXhpb3MucHV0KENvdWNoQXV0aC5mb3Ioc2xhdmV1c2VyLnVzZXIsIHNsYXZldXNlci5wYXNzd29yZCkgKyAnL3NlcnZpY2VfdGVzdGFwcC90ZXN0bmV3ZG9jMCcsIHsgX2lkOiAndGVzdG5ld2RvYzAnLCBlZTogdHJ1ZSB9KS50aGVuKGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGQpLnRvLmJlLm9rXG4gICAgICAgICAgICAgICAgZXhwZWN0KGQpLnRvLmJlLmFuKCdvYmplY3QnKVxuICAgICAgICAgICAgICAgIGRvbmUoKVxuICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKVxuICAgICAgICAgICAgICAgIGRvbmUoRXJyb3IoZXJyKSlcblxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9KVxuXG4gICAgICAgIGl0KFwidW5yZWdpc3RlcmVkIHVzZXJzIGNhbid0IGFjY2Vzc1wiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgdGhpcy50aW1lb3V0KDIwMDAwKVxuXG4gICAgICAgICAgICBheGlvcy5nZXQoQ291Y2hBdXRoLnB1YmxpbmsgKyAnL3NlcnZpY2VfdGVzdGFwcC90ZXN0ZG9jdG9iZXByZXNlbnQwJykudGhlbihmdW5jdGlvbiAoZCkge1xuICAgICAgICAgICAgICAgIGRvbmUoRXJyb3IoSlNPTi5zdHJpbmdpZnkoZCkpKVxuICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGV4cGVjdChlcnIpLnRvLmJlLm9rXG4gICAgICAgICAgICAgICAgZG9uZSgpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuXG4gICAgICAgIGl0KFwib3RoZXIgdXNlcnMgY2FuJ3QgYWNjZXNzXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICB0aGlzLnRpbWVvdXQoMjAwMDApXG5cbiAgICAgICAgICAgIGF4aW9zLmdldChDb3VjaEF1dGguZm9yKHVzZXIwLnVzZXIsIHVzZXIwLnBhc3N3b3JkKSArICcvc2VydmljZV90ZXN0YXBwL3Rlc3Rkb2N0b2JlcHJlc2VudDAnKS50aGVuKGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICAgICAgZG9uZShuZXcgRXJyb3IoSlNPTi5zdHJpbmdpZnkoZCkpKVxuICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGV4cGVjdChlcnIpLnRvLmJlLm9rXG4gICAgICAgICAgICAgICAgZG9uZSgpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuXG5cbiAgICB9KVxuXG4gICAgZGVzY3JpYmUoXCJjcmVhdGUgYSBuZXcgcHVibGljIGFwcCAoYW4gYXBwIHJlYWQgb25seSlcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICBpdChcIm1haW4gYWRtaW4gYWRkIHJvIGFwcFwiLCBmdW5jdGlvbiAoZG9uZSkge1xuICAgICAgICAgICAgdGhpcy50aW1lb3V0KDIwMDAwKVxuXG4gICAgICAgICAgICBDb3VjaEF1dGguY3JlYXRlUHViQXBwKGFkbWluVXNlciwgJ3Rlc3RhcHAyJykudGhlbihmdW5jdGlvbiAoZCkge1xuICAgICAgICAgICAgICAgIGF4aW9zLnB1dChDb3VjaEF1dGgubXkoJ3B1Yl90ZXN0YXBwMicpICsgJy90ZXN0ZG9jdG9iZXByZXNlbnQwJywgeyBfaWQ6ICd0ZXN0ZG9jdG9iZXByZXNlbnQwJywgZWU6IHRydWUgfSkudGhlbihmdW5jdGlvbiAoZCkge1xuICAgICAgICAgICAgICAgICAgICBleHBlY3QoZCkudG8uYmUub2tcbiAgICAgICAgICAgICAgICAgICAgZXhwZWN0KGQpLnRvLmJlLmFuKCdvYmplY3QnKVxuICAgICAgICAgICAgICAgICAgICBkb25lKClcbiAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKVxuICAgICAgICAgICAgICAgICAgICBkb25lKG5ldyBFcnJvcihlcnIpKVxuICAgICAgICAgICAgICAgIH0pXG5cblxuICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGRvbmUobmV3IEVycm9yKGVycikpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuXG4gICAgICAgIGl0KFwidW5yZWdpc3RlcmVkIHVzZXJzIGNhbiByZWFkIGZyb20gYSBwdWJsaWMgYXBwXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICB0aGlzLnRpbWVvdXQoMjAwMDApXG5cbiAgICAgICAgICAgIGF4aW9zLmdldChDb3VjaEF1dGgucHVibGluayArICcvcHViX3Rlc3RhcHAyL3Rlc3Rkb2N0b2JlcHJlc2VudDAnKS50aGVuKGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGQpLnRvLmJlLm9rXG4gICAgICAgICAgICAgICAgZG9uZSgpXG5cbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycilcbiAgICAgICAgICAgICAgICBkb25lKG5ldyBFcnJvcihlcnIpKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgICAgaXQoXCJyZWdpc3RlcmVkIHVzZXJzIGNhbiByZWFkIGZyb20gYSBwdWJsaWMgYXBwXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICB0aGlzLnRpbWVvdXQoMjAwMDApXG5cbiAgICAgICAgICAgIGF4aW9zLmdldChDb3VjaEF1dGguZm9yKHVzZXIwLnVzZXIsIHVzZXIwLnBhc3N3b3JkKSArICcvcHViX3Rlc3RhcHAyL3Rlc3Rkb2N0b2JlcHJlc2VudDAnKS50aGVuKGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGQpLnRvLmJlLm9rXG4gICAgICAgICAgICAgICAgZG9uZSgpXG5cbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycilcbiAgICAgICAgICAgICAgICBkb25lKG5ldyBFcnJvcihlcnIpKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgICAgaXQoXCJ1bnJlZ2lzdGVyZWQgdXNlcnMgY2FuJ3QgYWRkIGRvY3MgdG8gYSBwdWJsaWMgYXBwXCIsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICB0aGlzLnRpbWVvdXQoMjAwMDApXG5cbiAgICAgICAgICAgIGF4aW9zLnB1dChDb3VjaEF1dGgucHVibGluayArICcvcHViX3Rlc3RhcHAyL2NjY24nLCB7IF9pZDogJ2NjY24nLCBhYTogdHJ1ZSB9KS50aGVuKGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihkKVxuICAgICAgICAgICAgICAgIGRvbmUobmV3IEVycm9yKEpTT04uc3RyaW5naWZ5KGQpKSlcbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBleHBlY3QoZXJyKS50by5iZS5va1xuICAgICAgICAgICAgICAgIGRvbmUoKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgICAgICBpdChcInJlZ2lzdGVyZWQgdXNlcnMgY2FuJ3QgYWRkIGRvY3NcIiwgZnVuY3Rpb24gKGRvbmUpIHtcbiAgICAgICAgICAgIHRoaXMudGltZW91dCgyMDAwMClcblxuICAgICAgICAgICAgYXhpb3MucHV0KENvdWNoQXV0aC5mb3IodXNlcjAudXNlciwgdXNlcjAucGFzc3dvcmQpICsgJy9wdWJfdGVzdGFwcDIvY2NjYicsIHsgX2lkOiAnY2NjYicsIGFhOiB0cnVlIH0pLnRoZW4oZnVuY3Rpb24gKGQpIHtcbiAgICAgICAgICAgICAgICBkb25lKG5ldyBFcnJvcihKU09OLnN0cmluZ2lmeShkKSkpXG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgZXhwZWN0KGVycikudG8uYmUub2tcbiAgICAgICAgICAgICAgICBkb25lKClcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG5cblxuICAgIH0pXG5cblxuICAgIFxuXG59KVxuXG5hZnRlcihmdW5jdGlvbiAoZG9uZSkge1xuICAgIFNlcnZlci5zdG9wKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZG9uZSgpXG4gICAgfSlcblxufSkiXX0=
